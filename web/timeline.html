<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nightbear Timeline</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.6/css/highcharts.css" />
  <style>
    html, body, #chart {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.6/highcharts.js"></script>
  <script>

    if (!localStorage.dbCredentials) localStorage.dbCredentials = prompt('Please enter your DB credentials') || '';

    var daysOffset = parseInt((location.hash.match(/(-?\d+)d/) || [])[0]) || 0;

    console.log('daysOffset =', daysOffset);

    getNightbearData()
      .then(
        res => console.info(res) || res,
        err => console.warn(err)
      )
      .then(nightbearToHighcharts)
      .then(renderChart)

    function changeSGVUnit(sgv) {
      return Math.round((sgv / 18) * 10) / 10;
    }

    function readableTime(ts) {
      return (new Date(ts) + '').replace(/.*?(\d+:\d+:\d+).*/, '$1');
    }

    function getNightbearData() {
      var startKey = new Date(Date.now() + 1000 * 60 * 60 * 24 * daysOffset).toISOString().split('T')[0];
      var endKey = new Date(Date.now() + 1000 * 60 * 60 * 24 * (daysOffset + 1)).toISOString().split('T')[0];
      var url = 'https://nightbear.cloudant.com/user_marja/_design/global_stats/_view/per_date_and_type?limit=1000&reduce=false&include_docs=true&inclusive_end=false&start_key=%5B%22' + startKey + '%22%5D&end_key=%5B%22' + endKey + '%22%5D';
      return fetch(url, { headers: { 'Authorization': 'Basic ' + btoa(localStorage.dbCredentials) } })
        .then(res => res.json())
        .then(res => res.rows.map(row => row.doc))
    }

    function nightbearToHighcharts(docs) {
      var groups = _.groupBy(
        docs.filter(doc => doc.nb_glucose_value),
        doc => doc.device
      );
      var sensorSeries = Object.keys(groups).map(device => ({
        name: device,
        data: groups[device].map(doc => ({ x: doc.date, y: doc.nb_glucose_value, fromDocId: doc._id }))
      }));
      var calibrations = {
        name: 'calibrations',
        data: docs
          .filter(doc => doc.type === 'mbg')
          .map(doc => ({ x: doc.date, y: changeSGVUnit(doc.mbg), fromDocId: doc._id }))
      };
      var nightbearRaw = {
        name: 'nightbear-raw',
        data: docs
          .filter(doc => doc.nb_raw_value)
          .map(doc => ({ x: doc.date, y: doc.nb_raw_value, fromDocId: doc._id }))
      };
      return sensorSeries.concat([ calibrations, nightbearRaw ]);
    }

    function renderChart(series) {
      Highcharts.chart('chart', {
        chart: {
          zoomType: 'x'
        },
        title: {
          text: 'Nightbear Daily Data Timeline'
        },
        subtitle: {
          text: document.ontouchstart === undefined ?
            'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
        },
        xAxis: {
          type: 'datetime',
          labels: {
            formatter: function () {
              return readableTime(this.value);
            }
          }
        },
        yAxis: {
          title: {
            enabled: false
          },
          plotBands: [
            { // low
              from: 0,
              to: 4,
            },
            { // high
              from: 12,
              to: Infinity,
            }
          ]
        },
        tooltip: {
          crosshairs: true,
          formatter: function() {
            return '' +
              'Device: ' + this.series.name + '<br>' +
              'Time: ' + readableTime(this.x) + '<br>' +
              'Value: ' + this.y + '<br>' +
              'ID: ' + this.point.fromDocId + '<br>' +
              '';
          }
        },
        series: series
      });
    }

  </script>
</body>
</html>
